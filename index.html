<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</title>
  <style>
    :root {
      --primary: #007bff;
      --danger: #dc3545;
      --border: #ddd;
      --bg: #fff;
      --text: #333;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 8px 16px;
      background: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    .tab-btn.active {
      background: var(--primary);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .header-info {
      margin-bottom: 20px;
      padding: 12px;
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 13px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 12px 0;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #444;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    h3 {
      text-align: center;
      margin: 20px 0 12px;
      color: var(--text);
      font-size: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 6px;
      border: 1px solid var(--border);
    }
    thead th {
      font-weight: 600;
      background: #f8f9fa;
    }

    .btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      margin: 5px;
    }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn-delete { background: var(--danger); padding: 2px 6px; font-size: 12px; }
    .no-print { display: none; }

    @media print {
      .no-print { display: block; }
      body { background: white; padding: 0; }
      .container { box-shadow: none; border: none; }
    }
  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<div class="container">
  <div id="auth-ui" style="position: fixed; top: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 4px; z-index: 999;">
    <div id="user-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button id="sign-in-btn" style="display:none;" onclick="signInWithGoogle()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
    <button id="sign-out-btn" style="display:none;" onclick="signOut()">–í—ã—Ö–æ–¥</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('form')">–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    <button class="tab-btn" onclick="switchTab('archive')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <div id="form-tab" class="tab-content active">
    <input type="hidden" id="claim-id">

    <div class="header-info">
      <strong>–ü–û–°–¢–ê–í–©–ò–ö:</strong> –û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é "–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û"<br>
      –ò–ù–ù 7723905004, –ö–ü–ü 772101001, –ö–æ–¥ –ø–æ –û–ö–ü–û 29289257<br>
      111674, –≥. –ú–æ—Å–∫–≤–∞, –≤–Ω.—Ç–µ—Ä.–≥. –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥ –ù–µ–∫—Ä–∞—Å–æ–≤–∫–∞, –ø—Ä-–∫—Ç –ó–∞—â–∏—Ç–Ω–∏–∫–æ–≤ –ú–æ—Å–∫–≤—ã<br>
      —Ç–µ–ª.: +7 999 599 00 03
    </div>

    <h3>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</h3>

    <div class="form-row">
      <div class="form-group">
        <label>–î–∞—Ç–∞</label>
        <input type="text" id="current-date" readonly>
      </div>
      <div class="form-group">
        <label>–ù–æ–º–µ—Ä –Ω–∞—Ä—è–¥–∞</label>
        <input type="text" id="order-number" placeholder="–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏" readonly>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ö–æ–º–ø–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞</label>
        <input type="text" id="client-company" placeholder="–û–û–û / –ò–ü / –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞">
      </div>
      <div class="form-group">
        <label>–ö–æ–Ω—Ç–∞–∫—Ç</label>
        <input type="text" id="contact" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ / —Ç–µ–ª–µ—Ñ–æ–Ω">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ú–∞—Å—Ç–µ—Ä</label>
        <input type="text" id="master" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
      </div>
      <div class="form-group">
        <label>–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞</label>
        <input type="text" id="client-name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
      </div>
      <div class="form-group">
        <label>–ú–∞—Ä–∫–∞</label>
        <input type="text" id="car-brand" placeholder="–ì–ê–ó–µ–ª—å, Ford Transit...">
      </div>
      <div class="form-group">
        <label>–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
        <input type="text" id="car-number" placeholder="A111BB77">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
        <input type="number" id="mileage" value="123456" min="0">
      </div>
    </div>

    <h3>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–∞–±–æ—Ç—ã</h3>
    <table id="works-table">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–°—Ç–æ—Ä–æ–Ω–∞</th>
          <th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="works-body"></tbody>
    </table>
    <button class="btn btn-sm" onclick="addWorkRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h3>
    <table id="completed-table">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–°—Ç–æ—Ä–æ–Ω–∞</th>
          <th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="completed-body"></tbody>
    </table>
    <button class="btn btn-sm" onclick="addCompletedRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <h3>–ó–∞–ø—á–∞—Å—Ç–∏</h3>
    <table id="parts-table">
      <thead>
        <tr>
          <th>‚Ññ</th>
          <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
          <th>–ï–¥. –∏–∑–º.</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–¶–µ–Ω–∞</th>
          <th>–°—É–º–º–∞</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody id="parts-body"></tbody>
    </table>
    <button class="btn btn-sm" onclick="addPartRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <div class="no-print">
      <button class="btn" onclick="printClaim()">üìÑ –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    </div>
  </div>

  <div id="archive-tab" class="tab-content">
    <h2>–ê—Ä—Ö–∏–≤ –∑–∞—è–≤–æ–∫</h2>
    <div id="archive-list" class="archive-list"></div>
    <div class="no-print" style="margin-top:20px;">
      <button class="btn btn-archive" style="background:#6c757d;" onclick="switchTab('form')">‚Üê –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</button>
    </div>
  </div>
</div>

<script>
  // === SUPABASE CONFIG ===
  const supabaseUrl = 'https://–≤–∞—à-–ø—Ä–æ–µ–∫—Ç.supabase.co'; // ‚Üê –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô
  const supabaseAnonKey = '–≤–∞—à-public-–∫–ª—é—á';              // ‚Üê –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô
  const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

  let workIndex = 1, completedIndex = 1, partIndex = 1;
  let currentUser = null, userRole = null;

  // === –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===
  async function signInWithGoogle() {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        redirectTo: window.location.origin + window.location.pathname
      }
    });
    if (error) alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
  }

  async function signOut() {
    await supabase.auth.signOut();
    window.location.reload();
  }

  // === –ù–ê–ë–õ–Æ–î–ï–ù–ò–ï ===
  supabase.auth.onAuthStateChange(async (event, session) => {
    if (event === 'SIGNED_IN' && session?.user) {
      currentUser = session.user;
      document.getElementById('user-status').textContent = `üë§ ${currentUser.email}`;
      document.getElementById('sign-in-btn').style.display = 'none';
      document.getElementById('sign-out-btn').style.display = 'inline-block';

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª—å
      const { data, error } = await supabase
        .from('users')
        .select('role')
        .eq('id', currentUser.id)
        .single();

      if (data) {
        userRole = data.role;
        if (userRole === 'admin') {
          document.getElementById('user-status').textContent += ' (–ê–¥–º–∏–Ω)';
        }
      } else {
        // –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
        await supabase.from('users').insert({
          id: currentUser.id,
          email: currentUser.email
        });
        userRole = 'user';
      }
      loadArchive();
    } else {
      currentUser = null; userRole = null;
      document.getElementById('user-status').textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
      document.getElementById('sign-in-btn').style.display = 'inline-block';
      document.getElementById('sign-out-btn').style.display = 'none';
    }
  });

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  document.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    document.getElementById('current-date').value =
      `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
    generateOrderNumber();
  });

  function generateOrderNumber() {
    const lastSeq = parseInt(localStorage.getItem('lastClaimSeq') || '0') + 1;
    localStorage.setItem('lastClaimSeq', lastSeq.toString());
    document.getElementById('order-number').value =
      `–°–¢–ê-${new Date().getFullYear()}-${String(lastSeq).padStart(3, '0')}`;
  }

  function addWorkRow() {
    const tbody = document.getElementById('works-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${workIndex}</td>
      <td><input type="text" placeholder="–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞"></td>
      <td><input type="number" value="1" min="1"></td>
      <td><select><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option><option>–ü–µ—Ä–µ–¥–Ω—è—è</option><option>–ó–∞–¥–Ω—è—è</option></select></td>
      <td><select><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option><option>–¶–µ–Ω—Ç—Ä</option></select></td>
      <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row); workIndex++;
  }

  function addCompletedRow() {
    const tbody = document.getElementById('completed-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${completedIndex}</td>
      <td><input type="text" placeholder="–ó–∞–º–µ–Ω–∞ –º–∞—Å–ª–∞"></td>
      <td><input type="number" value="1" min="1"></td>
      <td><select><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option><option>–ü–µ—Ä–µ–¥–Ω—è—è</option><option>–ó–∞–¥–Ω—è—è</option></select></td>
      <td><select><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option><option>–¶–µ–Ω—Ç—Ä</option></select></td>
      <td><input type="number" value="0" min="0" placeholder="–¶–µ–Ω–∞"></td>
      <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row); completedIndex++;
  }

  function addPartRow() {
    const tbody = document.getElementById('parts-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${partIndex}</td>
      <td><input type="text" placeholder="–§–∏–ª—å—Ç—Ä –º–∞—Å–ª—è–Ω—ã–π"></td>
      <td><select><option>—à—Ç.</option><option>–ª.</option><option>–∫–≥.</option></select></td>
      <td><input type="number" value="1" min="1"></td>
      <td><input type="number" value="0" min="0" placeholder="–¶–µ–Ω–∞"></td>
      <td class="sum-cell">0.00</td>
      <td><button class="btn-delete" onclick="deleteRow(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(row); partIndex++;
  }

  function deleteRow(btn) { btn.closest('tr').remove(); }

  function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    document.getElementById(`${tab}-tab`).classList.add('active');
    document.querySelector(`.tab-btn:nth-child(${tab === 'form' ? 1 : 2})`).classList.add('active');
    if (tab === 'archive') renderArchive();
  }

  async function renderArchive() {
    if (!currentUser) return;
    const { data, error } = await supabase
      .from('claims')
      .select('*')
      .order('created_at', { ascending: false });

    const el = document.getElementById('archive-list');
    el.innerHTML = error ? '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Ä—Ö–∏–≤–∞.</p>' :
      (data?.length ? data.map(c => `
        <div style="padding:12px;border:1px solid #ddd;margin-bottom:8px;border-radius:6px;background:#fafafa;">
          <strong>‚Ññ${c.order_number}</strong> ‚Äî ${c.client_company}<br>
          –ê–≤—Ç–æ: ${c.car_brand} (${c.car_number})<br>
          –°—Ç–∞—Ç—É—Å: <b>${c.status === 'zakaz_naryad' ? '–ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥' : '–ó–∞—è–≤–∫–∞'}</b><br>
          <button class="btn-sm" onclick="loadClaim('${c.id}')">‚úèÔ∏è –û—Ç–∫—Ä—ã—Ç—å</button>
        </div>
      `).join('') : '<p>–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç.</p>');
  }

  async function loadClaim(id) {
    const { data, error } = await supabase
      .from('claims')
      .select('*')
      .eq('id', id)
      .single();

    if (error || !data) return;

    if (data.status === 'zakaz_naryad') {
      alert('üîí –≠—Ç–æ –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥. –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.');
      return;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É (—É–ø—Ä–æ—â—ë–Ω–Ω–æ ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è)
    document.getElementById('claim-id').value = data.id;
    document.getElementById('order-number').value = data.order_number;
    document.getElementById('client-company').value = data.client_company;
    document.getElementById('contact').value = data.contact;
    document.getElementById('master').value = data.master;
    document.getElementById('client-name').value = data.client_name;
    document.getElementById('car-brand').value = data.car_brand;
    document.getElementById('car-number').value = data.car_number;
    document.getElementById('mileage').value = data.mileage || 0;

    switchTab('form');
  }

  function prepareData() {
    const fields = ['order-number', 'client-company', 'contact', 'master', 'client-name', 'car-brand', 'car-number', 'mileage'];
    const data = {};
    for (const f of fields) {
      const el = document.getElementById(f.replace('-', '_'));
      data[f.replace('-', '_')] = el?.value || '';
    }
    return {
      order_number: data['order_number'],
      client_company: data['client_company'],
      contact: data['contact'],
      master: data['master'],
      client_name: data['client_name'],
      car_brand: data['car_brand'],
      car_number: data['car_number'],
      mileage: parseInt(data['mileage']) || 0,
      status: 'zayavka',
      created_by: currentUser?.id || null
    };
  }

  async function printClaim() {
    if (!currentUser) { alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É'); return; }
    const data = prepareData();
    if (!data.order_number || !data.client_company) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    data.status = 'zakaz_naryad';
    const id = document.getElementById('claim-id').value;

    const { error } = id
      ? await supabase.from('claims').update(data).eq('id', id)
      : await supabase.from('claims').insert(data);

    if (error) alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
    else {
      alert('‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥!');
      window.print();
      resetForm();
    }
  }

  function resetForm() {
    document.getElementById('claim-id').value = '';
    ['client-company', 'contact', 'master', 'client-name', 'car-brand', 'car-number'].forEach(id => {
      document.getElementById(id).value = '';
    });
    document.getElementById('mileage').value = '123456';
    generateOrderNumber();
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
  supabase.auth.getSession().then(({ data }) => {
    if (data.session) currentUser = data.session.user;
  });
</script>

</body>
</html>
