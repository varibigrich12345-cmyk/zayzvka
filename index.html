<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</title>
  <style>
    :root { --primary:#007bff; --danger:#dc3545; --border:#ddd; --bg:#fff; --text:#333; }
    * { box-sizing: border-box; }
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif; background:#f8f9fa; padding:20px; margin:0; font-size:14px; }
    .container { max-width:960px; margin:0 auto; background:var(--bg); padding:20px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .tabs { display:flex; gap:10px; margin-bottom:20px; }
    .tab-btn { padding:8px 16px; background:#e9ecef; border:none; border-radius:4px; cursor:pointer; font-weight:600; }
    .tab-btn.active { background:var(--primary); color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .header-info { margin-bottom:20px; padding:12px; background:#fafafa; border:1px solid var(--border); border-radius:6px; font-size:13px; }
    .form-row { display:flex; flex-wrap:wrap; gap:12px; margin:12px 0; }
    .form-group { flex:1; min-width:200px; }
    .form-group label { display:block; font-weight:600; margin-bottom:4px; }
    .form-group input, .form-group select { width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; }
    h3 { text-align:center; margin:20px 0 12px; font-size:18px; }
    table { width:100%; border-collapse:collapse; margin:12px 0; font-size:13px; }
    th, td { padding:8px 6px; border:1px solid var(--border); }
    thead th { font-weight:600; background:#f8f9fa; }
    .btn { padding:8px 16px; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer; font-size:15px; font-weight:bold; margin:5px; }
    .btn-sm { padding:4px 8px; font-size:12px; }
    .btn-delete { background:var(--danger); padding:2px 6px; font-size:12px; }
    .no-print { display:none; }
    @media print { .no-print { display:block; } body { background:white; padding:0; } .container { box-shadow:none; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="container">
  <div id="auth-ui" style="position:fixed;top:10px;right:10px;background:#fff;padding:10px;border:1px solid #ddd;border-radius:4px;z-index:999;">
    <div id="user-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <button id="sign-in-btn" style="display:none;" onclick="signInWithGoogle()">–í–æ–π—Ç–∏</button>
    <button id="sign-out-btn" style="display:none;" onclick="signOut()">–í—ã—Ö–æ–¥</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('form')">–ó–∞—è–≤–∫–∞</button>
    <button class="tab-btn" onclick="switchTab('archive')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <div id="form-tab" class="tab-content active">
    <input type="hidden" id="claim-id">

    <div class="header-info">
      <strong>–ü–û–°–¢–ê–í–©–ò–ö:</strong> –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª
    </div>

    <h3>–ó–ê–Ø–í–ö–ê –ù–ê –†–ï–ú–û–ù–¢</h3>

    <div class="form-row">
      <div class="form-group"><label>–î–∞—Ç–∞</label><input id="current-date" readonly></div>
      <div class="form-group"><label>–ù–æ–º–µ—Ä</label><input id="order-number" readonly></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>–ö–æ–º–ø–∞–Ω–∏—è</label><input id="client-company"></div>
      <div class="form-group"><label>–ö–æ–Ω—Ç–∞–∫—Ç</label><input id="contact"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>–ú–∞—Å—Ç–µ—Ä</label><input id="master"></div>
      <div class="form-group"><label>–§–ò–û –∫–ª–∏–µ–Ω—Ç–∞</label><input id="client-name"></div>
      <div class="form-group"><label>–ú–∞—Ä–∫–∞</label><input id="car-brand"></div>
      <div class="form-group"><label>–ì–æ—Å–Ω–æ–º–µ—Ä</label><input id="car-number"></div>
    </div>

    <div class="form-row">
      <div class="form-group"><label>–ü—Ä–æ–±–µ–≥</label><input id="mileage" type="number" value="0"></div>
    </div>

    <h3>–ó–∞—è–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h3>
    <table><tbody id="works-body"></tbody></table>
    <button class="btn btn-sm" onclick="addWorkRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h3>
    <table><tbody id="completed-body"></tbody></table>
    <button class="btn btn-sm" onclick="addCompletedRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <h3>–ó–∞–ø—á–∞—Å—Ç–∏</h3>
    <table><tbody id="parts-body"></tbody></table>
    <button class="btn btn-sm" onclick="addPartRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>

    <div class="no-print"><button class="btn" onclick="printClaim()">–ü–µ—á–∞—Ç—å</button></div>
  </div>

  <div id="archive-tab" class="tab-content">
    <h3>–ê—Ä—Ö–∏–≤</h3>
    <div id="archive-list"></div>
  </div>
</div>

<script>
  const supabaseUrl = 'https://rylmxrzbxvnwjciuwweu.supabase.co';
  const supabaseAnonKey = 'sb_publishable_5zpXd8DbGPSrUhW15ImIGg_mhlzr1Jj';
  const { createClient } = supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

  let workIndex = 1, completedIndex = 1, partIndex = 1;
  let currentUser = null;

  document.addEventListener('DOMContentLoaded', () => {
    const now = new Date();
    document.getElementById('current-date').value = now.toLocaleDateString('ru-RU');
    generateOrderNumber();
  });

  function generateOrderNumber() {
    const last = (parseInt(localStorage.getItem('lastClaimSeq')) || 0) + 1;
    localStorage.setItem('lastClaimSeq', last);
    document.getElementById('order-number').value = '–°–¢–ê-' + new Date().getFullYear() + '-' + String(last).padStart(3,'0');
  }

  async function signInWithGoogle() {
    await supabaseClient.auth.signInWithOAuth({ provider:'google' });
  }

  async function signOut() {
    await supabaseClient.auth.signOut(); location.reload();
  }

  supabaseClient.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user || null;
    document.getElementById('user-status').textContent = currentUser ? currentUser.email : '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
    document.getElementById('sign-in-btn').style.display = currentUser ? 'none' : 'inline-block';
    document.getElementById('sign-out-btn').style.display = currentUser ? 'inline-block' : 'none';
  });

  function addWorkRow() {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${workIndex}</td><td><input></td><td><button onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
    document.getElementById('works-body').appendChild(tr); workIndex++;
  }

  function addCompletedRow() {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${completedIndex}</td><td><input></td><td><input type=number></td><td><button onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
    document.getElementById('completed-body').appendChild(tr); completedIndex++;
  }

  function addPartRow() {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${partIndex}</td><td><input></td><td><input type=number></td><td><button onclick="deleteRow(this)">üóëÔ∏è</button></td>`;
    document.getElementById('parts-body').appendChild(tr); partIndex++;
  }

  function deleteRow(btn){ btn.closest('tr').remove(); }

  function switchTab(tab){
    document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
    document.getElementById(tab+'-tab').classList.add('active');
    if(tab==='archive') renderArchive();
  }

  async function renderArchive(){
    if(!currentUser) return;
    const { data } = await supabaseClient.from('claims').select('*').order('created_at',{ascending:false});
    document.getElementById('archive-list').innerHTML = data?.map(c=>`<div>${c.order_number}</div>`).join('');
  }

  async function printClaim(){
    if(!currentUser){ alert('–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏'); return; }
    const data={ order_number:orderNumber.value, client_company:clientCompany.value };
    const { error } = await supabaseClient.from('claims').insert(data);
    if(error) alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); else window.print();
  }
</script>
</body>
</html>
