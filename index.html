<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ‚Äî –û–û–û ¬´–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û¬ª</title>
  <style>
    :root {
      --text: #333;
      --border: #ccc;
      --bg: #fff;
      --primary: #007bff;
      --danger: #dc3545;
      --success: #28a745;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f8f9fa;
      padding: 10px;
      margin: 0;
      font-size: 14px;
      line-height: 1.5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: var(--bg);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h2, h3 {
      text-align: center;
      margin: 16px 0 12px;
      color: var(--text);
      font-size: 18px;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 13px;
      line-height: 1.4;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 12px 0;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
      color: #444;
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 8px 6px;
      border-bottom: 1px solid var(--border);
    }
    thead th {
      font-weight: 600;
      background: #f8f9fa;
    }
    .preview-table th, .preview-table td {
      border: none;
      border-bottom: 1px solid #000;
    }
    .btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 15px;
      font-weight: bold;
      margin: 5px;
    }
    .btn-save { background: var(--success); }
    .btn-archive { background: #6c757d; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn-delete { background: var(--danger); padding: 2px 6px; font-size: 12px; }
    .no-print {
      display: block;
      text-align: center;
      margin-top: 10px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 8px 16px;
      background: #e9ecef;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .tab-btn.active {
      background: var(--primary);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .archive-list {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }
    .archive-item {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
    }
    .archive-item:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('form')">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
    <button class="tab-btn" onclick="switchTab('archive')">–ê—Ä—Ö–∏–≤</button>
  </div>

  <!-- === –û–°–ù–û–í–ù–ê–Ø –§–û–†–ú–ê === -->
  <div id="form-tab" class="tab-content active">
    <div class="header-row">
      <div>
        –ü–û–°–¢–ê–í–©–ò–ö: –û–±—â–µ—Å—Ç–≤–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å—é "–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û"<br>
        –ò–ù–ù 7723905004, –ö–ü–ü 772101001<br>
        111674, –≥. –ú–æ—Å–∫–≤–∞, –≤–Ω.—Ç–µ—Ä.–≥. –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥ –ù–µ–∫—Ä–∞—Å–æ–≤–∫–∞, –ø—Ä-–∫—Ç –ó–∞—â–∏—Ç–Ω–∏–∫–æ–≤ –ú–æ—Å–∫–≤—ã<br>
        —Ç–µ–ª.: +7 (929) 774-88-66, –ö–æ–¥ –ø–æ –û–ö–ü–û 29289257
      </div>
      <div><strong>–î–∞—Ç–∞:</strong> <span id="current-date">‚Äî</span></div>
    </div>

    <h2>–§–æ—Ä–º–∞ –∑–∞—è–≤–∫–∏</h2>

    <div class="form-row">
      <div class="form-group">
        <label>–ù–æ–º–µ—Ä –Ω–∞—Ä—è–¥–∞</label>
        <input type="text" id="order-number" readonly>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ö–æ–º–ø–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞</label>
        <input type="text" id="client-company" placeholder="–û–û–û / –ò–ü / –§–ò–û –∫–ª–∏–µ–Ω—Ç–∞">
      </div>
      <div class="form-group">
        <label>–ö–æ–Ω—Ç–∞–∫—Ç</label>
        <input type="text" id="client-contact" placeholder="–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ / —Ç–µ–ª–µ—Ñ–æ–Ω">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>–ú–∞—Å—Ç–µ—Ä</label>
        <input type="text" id="master-name" placeholder="–ò–≤–∞–Ω–æ–≤ –ò.–ò.">
      </div>
      <div class="form-group">
        <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤—ã–µ–∑–¥–∞</label>
        <input type="text" id="field-agent" placeholder="–ü–µ—Ç—Ä–æ–≤ –ü.–ü.">
      </div>
      <div class="form-group">
        <label>–ú–∞—Ä–∫–∞</label>
        <input type="text" id="vehicle-brand" placeholder="–ì–ê–ó–µ–ª—å, Ford Transit...">
      </div>
      <div class="form-group">
        <label>–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
        <input type="text" id="license-plate" placeholder="–ê111–í–í77">
      </div>
      <div class="form-group">
        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
        <input type="text" id="client-phone" placeholder="89123456789">
      </div>
      <div class="form-group">
        <label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
        <input type="number" id="mileage" placeholder="123456">
      </div>
    </div>

    <h3>–ó–∞—è–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h3>
    <div class="form-row">
      <input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" id="work-desc1" style="flex:2;">
      <input type="number" placeholder="–ö–æ–ª-–≤–æ" id="work-qty1" value="1" min="1" style="width:80px;">
      <select id="work-side1" style="width:100px;"><option>‚Äî</option><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option></select>
      <select id="work-pos1" style="width:100px;"><option>‚Äî</option><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option></select>
      <button class="btn-sm" onclick="addWorkRow('planned')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <table id="planned-table">
      <thead><tr><th>‚Ññ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ç–æ—Ä–æ–Ω–∞</th><th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <h3>–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã</h3>
    <div class="form-row">
      <input type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" id="work-desc2" style="flex:2;">
      <input type="number" placeholder="–ö–æ–ª-–≤–æ" id="work-qty2" value="1" min="1" style="width:80px;">
      <select id="work-side2" style="width:100px;"><option>‚Äî</option><option>–õ–µ–≤–∞—è</option><option>–ü—Ä–∞–≤–∞—è</option></select>
      <select id="work-pos2" style="width:100px;"><option>‚Äî</option><option>–í–µ—Ä—Ö</option><option>–ù–∏–∑</option></select>
      <input type="number" placeholder="–¶–µ–Ω–∞" id="work-price2" style="width:100px;">
      <button class="btn-sm" onclick="addWorkRow('actual')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <table id="actual-table">
      <thead><tr><th>‚Ññ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–°—Ç–æ—Ä–æ–Ω–∞</th><th>–ü–æ–ª–æ–∂–µ–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <h3>–ó–∞–ø—á–∞—Å—Ç–∏</h3>
    <div class="form-row">
      <input type="text" placeholder="–ê—Ä—Ç–∏–∫—É–ª" id="part-art" style="width:120px;">
      <input type="text" placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ" id="part-name" style="flex:2;">
      <input type="number" placeholder="–ö–æ–ª-–≤–æ" id="part-qty" value="1" min="1" style="width:80px;">
      <input type="number" placeholder="–¶–µ–Ω–∞" id="part-price" style="width:100px;">
      <button class="btn-sm" onclick="addPartRow()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
    <table id="parts-table">
      <thead><tr><th>‚Ññ</th><th>–ê—Ä—Ç–∏–∫—É–ª</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
      <tbody></tbody>
    </table>

    <div class="no-print">
      <button class="btn" onclick="printClaim()">üìÑ –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∑–∞—è–≤–∫—É</button>
      <button class="btn" style="background:#28a745;" onclick="printOrder()">üñ®Ô∏è –†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥</button>
      <button class="btn btn-save" onclick="saveClaim()">‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∞—Ä—Ö–∏–≤</button>
      <button class="btn btn-save" onclick="exportTo1C()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV –¥–ª—è 1–°</button>
    </div>
  </div>

  <!-- === –ê–†–•–ò–í === -->
  <div id="archive-tab" class="tab-content">
    <h2>–ê—Ä—Ö–∏–≤ –∑–∞—è–≤–æ–∫</h2>
    <div id="archive-list" class="archive-list"></div>
    <div class="no-print" style="margin-top:20px;">
      <button class="btn btn-archive" onclick="switchTab('form')">‚Üê –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</button>
    </div>
  </div>
</div>

<script>
  let workIndex = 1, actualIndex = 1, partIndex = 1;
  let lastSeq = parseInt(localStorage.getItem('lastClaimSeq') || '0');

  // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
  init();

  function init() {
    const now = new Date();
    const d = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()}`;
    document.getElementById('current-date').textContent = d;
    generateOrderNumber();
    loadArchive();
  }

  function generateOrderNumber() {
    lastSeq++;
    localStorage.setItem('lastClaimSeq', lastSeq.toString());
    document.getElementById('order-number').value = `–°–¢–ê-${new Date().getFullYear()}-${String(lastSeq).padStart(3, '0')}`;
  }

  // === –†–ê–ë–û–¢–ê –° –¢–ê–ë–õ–ò–¶–ê–ú–ò ===
  function addWorkRow(type) {
    const isPlanned = type === 'planned';
    const desc = (isPlanned ? document.getElementById('work-desc1') : document.getElementById('work-desc2')).value || '‚Äî';
    const qty = (isPlanned ? document.getElementById('work-qty1') : document.getElementById('work-qty2')).value || 1;
    const side = (isPlanned ? document.getElementById('work-side1') : document.getElementById('work-side2')).value || '‚Äî';
    const pos = (isPlanned ? document.getElementById('work-pos1') : document.getElementById('work-pos2')).value || '‚Äî';
    const price = isPlanned ? null : parseFloat(document.getElementById('work-price2').value) || 0;
    const total = isPlanned ? null : qty * price;
    const tbody = document.querySelector(`#${type}-table tbody`);
    const row = tbody.insertRow();
    const idx = isPlanned ? workIndex++ : actualIndex++;
    const cells = [
      { t: idx },
      { t: desc },
      { t: qty },
      { t: side },
      { t: pos },
      ...(isPlanned ? [] : [{ t: price }, { t: total }]),
      { h: `<button class="btn-delete" onclick="removeRow(this)">‚úï</button>` }
    ];
    cells.forEach(c => {
      const td = document.createElement('td');
      td[c.h ? 'innerHTML' : 'textContent'] = c.t || c.h;
      row.appendChild(td);
    });
  }

  function addPartRow() {
    const art = document.getElementById('part-art').value || '‚Äî';
    const name = document.getElementById('part-name').value || '‚Äî';
    const qty = document.getElementById('part-qty').value || 1;
    const price = parseFloat(document.getElementById('part-price').value) || 0;
    const total = qty * price;
    const tbody = document.querySelector('#parts-table tbody');
    const row = tbody.insertRow();
    const idx = partIndex++;
    const cells = [
      { t: idx }, { t: art }, { t: name }, { t: qty }, { t: price }, { t: total },
      { h: `<button class="btn-delete" onclick="removeRow(this)">‚úï</button>` }
    ];
    cells.forEach(c => {
      const td = document.createElement('td');
      td[c.h ? 'innerHTML' : 'textContent'] = c.t || c.h;
      row.appendChild(td);
    });
  }

  function removeRow(btn) { btn.closest('tr').remove(); }

  // === –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ê–†–•–ò–í ===
  function saveClaim() {
    const data = {
      id: Date.now(),
      header: {
        order: document.getElementById('order-number').value,
        date: document.getElementById('current-date').textContent,
        company: document.getElementById('client-company').value || '‚Äî',
        contact: document.getElementById('client-contact').value || '‚Äî',
        master: document.getElementById('master-name').value || '‚Äî',
        agent: document.getElementById('field-agent').value || '‚Äî',
        brand: document.getElementById('vehicle-brand').value || '‚Äî',
        plate: document.getElementById('license-plate').value || '‚Äî',
        phone: document.getElementById('client-phone').value || '‚Äî',
        mileage: (document.getElementById('mileage').value || '‚Äî') + ' –∫–º'
      },
      planned: getTableData('planned-table', false),
      actual: getTableData('actual-table', true),
      parts: getTableData('parts-table', true),
      savedAt: new Date().toISOString()
    };

    // –í—ã—á–∏—Å–ª—è–µ–º –∏—Ç–æ–≥–∏
    let works = 0, parts = 0;
    data.actual.forEach(r => works += parseFloat(r.total) || 0);
    data.parts.forEach(r => parts += parseFloat(r.total) || 0);
    data.totals = {
      works: works.toFixed(2),
      parts: parts.toFixed(2),
      grand: (works + parts).toFixed(2)
    };

    const key = 'claims';
    let list = JSON.parse(localStorage.getItem(key) || '[]');
    list.push(data);
    localStorage.setItem(key, JSON.stringify(list));
    alert(`‚úÖ –ó–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∞—Ä—Ö–∏–≤!\n–ù–æ–º–µ—Ä: ${data.header.order}`);
    loadArchive();
  }

  function getTableData(tableId, hasPrice) {
    const rows = [];
    document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
      const c = row.cells;
      if (tableId === 'parts-table') {
        rows.push({ art: c[1].textContent, name: c[2].textContent, qty: c[3].textContent, price: c[4].textContent, total: c[5].textContent });
      } else if (hasPrice) {
        rows.push({ desc: c[1].textContent, qty: c[2].textContent, side: c[3].textContent, pos: c[4].textContent, price: c[5].textContent, total: c[6].textContent });
      } else {
        rows.push({ desc: c[1].textContent, qty: c[2].textContent, side: c[3].textContent, pos: c[4].textContent });
      }
    });
    return rows;
  }

  // === –ó–ê–ì–†–£–ó–ö–ê –ê–†–•–ò–í–ê ===
  function loadArchive() {
    const list = JSON.parse(localStorage.getItem('claims') || '[]');
    const container = document.getElementById('archive-list');
    container.innerHTML = '';
    if (list.length === 0) {
      container.innerHTML = '<div style="text-align:center; color:#666;">–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</div>';
      return;
    }
    list.sort((a, b) => new Date(b.header.date.split('.').reverse().join('-')) - new Date(a.header.date.split('.').reverse().join('-')));
    list.forEach(item => {
      const div = document.createElement('div');
      div.className = 'archive-item';
      div.innerHTML = `
        <strong>–ó–∞—è–≤–∫–∞ –æ—Ç ${item.header.date}</strong><br>
        –ù–æ–º–µ—Ä: ${item.header.order}<br>
        –ö–æ–º–ø–∞–Ω–∏—è: ${item.header.company}<br>
        –ò—Ç–æ–≥–æ: ${item.totals.grand} ‚ÇΩ
        <div style="margin-top:8px;">
          <button class="btn-sm" style="background:#17a2b8;" onclick="loadClaim(${item.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="btn-sm" style="background:#28a745;" onclick="printClaimFromArchive(${item.id})">–ü–µ—á–∞—Ç—å</button>
        </div>
      `;
      container.appendChild(div);
    });
  }

  // === –ó–ê–ì–†–£–ó–ö–ê –ó–ê–Ø–í–ö–ò –í –§–û–†–ú–£ ===
  function loadClaim(id) {
    const list = JSON.parse(localStorage.getItem('claims') || '[]');
    const item = list.find(x => x.id == id);
    if (!item) return;

    // –û—á–∏—Å—Ç–∫–∞
    ['planned-table', 'actual-table', 'parts-table'].forEach(id => {
      document.querySelector(`#${id} tbody`).innerHTML = '';
    });
    workIndex = 1; actualIndex = 1; partIndex = 1;
    lastSeq = parseInt(item.header.order.split('-')[2]) - 1;

    // –ü–æ–ª—è
    document.getElementById('order-number').value = item.header.order;
    document.getElementById('client-company').value = item.header.company === '‚Äî' ? '' : item.header.company;
    document.getElementById('client-contact').value = item.header.contact === '‚Äî' ? '' : item.header.contact;
    document.getElementById('master-name').value = item.header.master === '‚Äî' ? '' : item.header.master;
    document.getElementById('field-agent').value = item.header.agent === '‚Äî' ? '' : item.header.agent;
    document.getElementById('vehicle-brand').value = item.header.brand === '‚Äî' ? '' : item.header.brand;
    document.getElementById('license-plate').value = item.header.plate === '‚Äî' ? '' : item.header.plate;
    document.getElementById('client-phone').value = item.header.phone === '‚Äî' ? '' : item.header.phone;
    document.getElementById('mileage').value = item.header.mileage.replace(' –∫–º', '').replace('‚Äî', '');

    // –¢–∞–±–ª–∏—Ü—ã
    item.planned.forEach(row => {
      const tr = document.querySelector('#planned-table tbody').insertRow();
      const idx = workIndex++;
      const cells = [
        { t: idx }, { t: row.desc }, { t: row.qty }, { t: row.side }, { t: row.pos },
        { h: `<button class="btn-delete" onclick="removeRow(this)">‚úï</button>` }
      ];
      cells.forEach(c => {
        const td = document.createElement('td');
        td[c.h ? 'innerHTML' : 'textContent'] = c.t || c.h;
        tr.appendChild(td);
      });
    });

    item.actual.forEach(row => {
      const tr = document.querySelector('#actual-table tbody').insertRow();
      const idx = actualIndex++;
      const cells = [
        { t: idx }, { t: row.desc }, { t: row.qty }, { t: row.side }, { t: row.pos },
        { t: row.price }, { t: row.total },
        { h: `<button class="btn-delete" onclick="removeRow(this)">‚úï</button>` }
      ];
      cells.forEach(c => {
        const td = document.createElement('td');
        td[c.h ? 'innerHTML' : 'textContent'] = c.t || c.h;
        tr.appendChild(td);
      });
    });

    item.parts.forEach(row => {
      const tr = document.querySelector('#parts-table tbody').insertRow();
      const idx = partIndex++;
      const cells = [
        { t: idx }, { t: row.art }, { t: row.name }, { t: row.qty }, { t: row.price }, { t: row.total },
        { h: `<button class="btn-delete" onclick="removeRow(this)">‚úï</button>` }
      ];
      cells.forEach(c => {
        const td = document.createElement('td');
        td[c.h ? 'innerHTML' : 'textContent'] = c.t || c.h;
        tr.appendChild(td);
      });
    });

    switchTab('form');
  }

  function printClaimFromArchive(id) {
    loadClaim(id);
    setTimeout(printClaim, 100);
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(`${tab}-tab`).classList.add('active');
    document.querySelector(`.tab-btn:nth-child(${tab === 'form' ? 1 : 2})`).classList.add('active');
  }

  // === –ü–ï–ß–ê–¢–¨ –° –ò–¢–û–ì–ê–ú–ò –ò –ü–û–î–ü–ò–°–Ø–ú–ò ===
  function printClaim() {
    const d = document.getElementById('current-date').textContent;
    const n = document.getElementById('order-number').value;
    const c = document.getElementById('client-company').value || '‚Äî';
    const ct = document.getElementById('client-contact').value || '‚Äî';
    const m = document.getElementById('master-name').value || '‚Äî';
    const a = document.getElementById('field-agent').value || '‚Äî';
    const b = document.getElementById('vehicle-brand').value || '‚Äî';
    const p = document.getElementById('license-plate').value || '‚Äî';
    const ph = document.getElementById('client-phone').value || '‚Äî';
    const mi = (document.getElementById('mileage').value || '‚Äî') + ' –∫–º';

    let works = 0, parts = 0;
    document.querySelectorAll('#actual-table tbody tr').forEach(row => {
      works += parseFloat(row.cells[6]?.textContent) || 0;
    });
    document.querySelectorAll('#parts-table tbody tr').forEach(row => {
      parts += parseFloat(row.cells[5]?.textContent) || 0;
    });
    const grand = works + parts;

    let html = `
      <div style="font-family:Arial,sans-serif; padding:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:13px;">
          <div><strong>–ü–û–°–¢–ê–í–©–ò–ö:</strong> –û–û–û "–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û"<br>–ò–ù–ù 7723905004, –ö–ü–ü 772101001<br>111674, –≥. –ú–æ—Å–∫–≤–∞, –ø—Ä-–∫—Ç –ó–∞—â–∏—Ç–Ω–∏–∫–æ–≤ –ú–æ—Å–∫–≤—ã<br>—Ç–µ–ª.: +7 (929) 774-88-66, –ö–æ–¥ –ø–æ –û–ö–ü–û 29289257</div>
          <div><strong>–î–∞—Ç–∞:</strong> ${d}</div>
        </div>
        <div style="text-align:center; font-weight:bold; margin:12px 0; font-size:18px;">–ó–ê–Ø–í–ö–ê –ù–ê –†–ï–ú–û–ù–¢</div>

        <table style="width:100%; border-collapse:collapse; font-size:13px; margin-bottom:16px;">
          <tr><td style="padding:4px;">–ù–æ–º–µ—Ä –Ω–∞—Ä—è–¥–∞: ${n}</td><td style="padding:4px;">–î–∞—Ç–∞: ${d}</td></tr>
          <tr><td style="padding:4px;">–ö–æ–º–ø–∞–Ω–∏—è: ${c}</td><td style="padding:4px;">–ö–æ–Ω—Ç–∞–∫—Ç: ${ct}</td></tr>
          <tr><td style="padding:4px;">–ú–∞—Å—Ç–µ—Ä: ${m}</td><td style="padding:4px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤—ã–µ–∑–¥–∞: ${a}</td></tr>
          <tr><td style="padding:4px;">–ú–∞—Ä–∫–∞: ${b}</td><td style="padding:4px;">–ì–æ—Å. –Ω–æ–º–µ—Ä: ${p}</td></tr>
          <tr><td style="padding:4px;">–¢–µ–ª–µ—Ñ–æ–Ω: ${ph}</td><td style="padding:4px;">–ü—Ä–æ–±–µ–≥: ${mi}</td></tr>
        </table>
    `;

    html += createTableHTML('–ó–∞—è–≤–ª–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', 'planned-table', false);
    html += createTableHTML('–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', 'actual-table', true);
    html += createTableHTML('–ó–∞–ø—á–∞—Å—Ç–∏', 'parts-table', true, true);

    html += `
      <div style="margin-top:20px; text-align:right; font-weight:bold; font-size:16px;">
        <div>–ò—Ç–æ–≥–æ —Ä–∞–±–æ—Ç: ${works.toFixed(2)} ‚ÇΩ</div>
        <div>–ò—Ç–æ–≥–æ –∑–∞–ø—á–∞—Å—Ç–µ–π: ${parts.toFixed(2)} ‚ÇΩ</div>
        <div>–û–±—â–∞—è —Å—É–º–º–∞: ${grand.toFixed(2)} ‚ÇΩ</div>
      </div>

      <div style="margin-top:40px; font-size:14px;">
        <table style="width:100%; border-collapse:collapse;">
          <tr>
            <td style="padding:4px; width:50%;">
              <div>–ú–∞—Å—Ç–µ—Ä: _________________________</div>
              <div style="margin-top:5px;">(${m})</div>
            </td>
            <td style="padding:4px; width:50%;">
              <div>–ü–µ—á–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:</div>
              <div style="margin-top:25px; border-top:1px solid #000; width:80%;"></div>
            </td>
          </tr>
        </table>
      </div>
    </div>
    `;

    printWindow(html);
  }

  function printOrder() {
    const d = document.getElementById('current-date').textContent;
    const n = document.getElementById('order-number').value;
    const m = document.getElementById('master-name').value || '‚Äî';

    let works = 0, parts = 0;
    document.querySelectorAll('#actual-table tbody tr').forEach(row => {
      works += parseFloat(row.cells[6]?.textContent) || 0;
    });
    document.querySelectorAll('#parts-table tbody tr').forEach(row => {
      parts += parseFloat(row.cells[5]?.textContent) || 0;
    });
    const grand = works + parts;

    let html = `
      <div style="font-family:Arial,sans-serif; padding:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px; font-size:13px;">
          <div><strong>–ü–û–°–¢–ê–í–©–ò–ö:</strong> –û–û–û "–°–ï–†–í–ò–°–¢–†–ê–ù–°–ê–í–¢–û"<br>–ò–ù–ù 7723905004, –ö–ü–ü 772101001<br>111674, –≥. –ú–æ—Å–∫–≤–∞, –ø—Ä-–∫—Ç –ó–∞—â–∏—Ç–Ω–∏–∫–æ–≤ –ú–æ—Å–∫–≤—ã<br>—Ç–µ–ª.: +7 (929) 774-88-66, –ö–æ–¥ –ø–æ –û–ö–ü–û 29289257</div>
          <div><strong>–î–∞—Ç–∞:</strong> ${d}</div>
        </div>
        <div style="text-align:center; font-weight:bold; margin:12px 0; font-size:18px;">–ó–ê–ö–ê–ó-–ù–ê–†–Ø–î ‚Ññ${n}</div>
    `;

    html += createTableHTML('–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã', 'actual-table', true);
    html += createTableHTML('–ó–∞–ø—á–∞—Å—Ç–∏', 'parts-table', true, true);

    html += `
      <div style="margin-top:20px; text-align:right; font-weight:bold; font-size:16px;">
        <div>–ò—Ç–æ–≥–æ —Ä–∞–±–æ—Ç: ${works.toFixed(2)} ‚ÇΩ</div>
        <div>–ò—Ç–æ–≥–æ –∑–∞–ø—á–∞—Å—Ç–µ–π: ${parts.toFixed(2)} ‚ÇΩ</div>
        <div>–û–±—â–∞—è —Å—É–º–º–∞: ${grand.toFixed(2)} ‚ÇΩ</div>
      </div>

      <div style="margin-top:40px; font-size:14px;">
        <table style="width:100%; border-collapse:collapse;">
          <tr>
            <td style="padding:4px; width:50%;">
              <div>–ú–∞—Å—Ç–µ—Ä: _________________________</div>
              <div style="margin-top:5px;">(${m})</div>
            </td>
            <td style="padding:4px; width:50%;">
              <div>–ü–µ—á–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:</div>
              <div style="margin-top:25px; border-top:1px solid #000; width:80%;"></div>
            </td>
          </tr>
        </table>
      </div>
    </div>
    `;

    printWindow(html);
  }

  function createTableHTML(title, tableId, hasPrice, isPart = false) {
    let html = `<h3 style="margin:12px 0; font-size:15px;">${title}</h3><table style="width:100%; border-collapse:collapse;">`;
    const headers = isPart ? ['‚Ññ','–ê—Ä—Ç–∏–∫—É–ª','–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ö–æ–ª-–≤–æ','–¶–µ–Ω–∞','–°—É–º–º–∞']
                 : hasPrice ? ['‚Ññ','–û–ø–∏—Å–∞–Ω–∏–µ','–ö–æ–ª-–≤–æ','–°—Ç–æ—Ä–æ–Ω–∞','–ü–æ–ª–æ–∂–µ–Ω–∏–µ','–¶–µ–Ω–∞','–°—É–º–º–∞']
                 : ['‚Ññ','–û–ø–∏—Å–∞–Ω–∏–µ','–ö–æ–ª-–≤–æ','–°—Ç–æ—Ä–æ–Ω–∞','–ü–æ–ª–æ–∂–µ–Ω–∏–µ'];
    html += '<thead><tr>';
    headers.forEach(h => html += `<th style="text-align:left; padding:6px; border-bottom:1px solid #000;">${h}</th>`);
    html += '</tr></thead><tbody>';

    const rows = tableId === 'planned-table' ? document.querySelectorAll('#planned-table tbody tr')
               : tableId === 'actual-table' ? document.querySelectorAll('#actual-table tbody tr')
               : document.querySelectorAll('#parts-table tbody tr');

    rows.forEach((row, i) => {
      html += '<tr>';
      if (isPart) {
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${i+1}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[1].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[2].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[3].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[4].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[5].textContent}</td>`;
      } else if (hasPrice) {
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${i+1}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[1].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[2].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[3].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[4].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[5].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[6].textContent}</td>`;
      } else {
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${i+1}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[1].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[2].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[3].textContent}</td>`;
        html += `<td style="padding:6px; border-bottom:1px solid #000;">${row.cells[4].textContent}</td>`;
      }
      html += '</tr>';
    });
    html += '</tbody></table>';
    return html;
  }

  function printWindow(html) {
    const win = window.open('', '_blank');
    if (!win) {
      alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è –ø–µ—á–∞—Ç–∏.');
      return;
    }
    win.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>–ü–µ—á–∞—Ç—å</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          table { width: 100%; border-collapse: collapse; margin: 10px 0; }
          th, td { text-align: left; padding: 6px; border-bottom: 1px solid #000; }
        </style>
      </head>
      <body>
        ${html}
      </body>
      </html>
    `);
    win.document.close();
    win.focus();
    win.onload = () => {
      try { win.print(); } catch (e) { alert('–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏'); }
    };
  }

  // === –≠–ö–°–ü–û–†–¢ –í CSV ===
  function exportTo1C() {
    const order = document.getElementById('order-number').value;
    const date = document.getElementById('current-date').textContent;
    const company = document.getElementById('client-company').value || '';
    const contact = document.getElementById('client-contact').value || '';
    const master = document.getElementById('master-name').value || '';
    const agent = document.getElementById('field-agent').value || '';
    const brand = document.getElementById('vehicle-brand').value || '';
    const plate = document.getElementById('license-plate').value || '';
    const phone = document.getElementById('client-phone').value || '';
    const mileage = document.getElementById('mileage').value || '';

    let lines = [];
    document.querySelectorAll('#planned-table tbody tr').forEach(row => {
      lines.push([order,date,company,contact,master,agent,brand,plate,phone,mileage,'–ó–∞—è–≤–ª–µ–Ω–Ω–∞—è',row.cells[1].textContent,row.cells[2].textContent,row.cells[3].textContent,row.cells[4].textContent,'','','']);
    });
    document.querySelectorAll('#actual-table tbody tr').forEach(row => {
      lines.push([order,date,company,contact,master,agent,brand,plate,phone,mileage,'–í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è',row.cells[1].textContent,row.cells[2].textContent,row.cells[3].textContent,row.cells[4].textContent,'',row.cells[5].textContent,row.cells[6].textContent]);
    });
    document.querySelectorAll('#parts-table tbody tr').forEach(row => {
      lines.push([order,date,company,contact,master,agent,brand,plate,phone,mileage,'–ó–∞–ø—á–∞—Å—Ç—å',row.cells[2].textContent,row.cells[3].textContent,'','',row.cells[1].textContent,row.cells[4].textContent,row.cells[5].textContent]);
    });

    const header = ['–ù–æ–º–µ—Ä –Ω–∞—Ä—è–¥–∞','–î–∞—Ç–∞','–ö–æ–º–ø–∞–Ω–∏—è','–ö–æ–Ω—Ç–∞–∫—Ç','–ú–∞—Å—Ç–µ—Ä','–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤—ã–µ–∑–¥–∞','–ú–∞—Ä–∫–∞','–ì–æ—Å. –Ω–æ–º–µ—Ä','–¢–µ–ª–µ—Ñ–æ–Ω','–ü—Ä–æ–±–µ–≥ (–∫–º)','–¢–∏–ø —Å—Ç—Ä–æ–∫–∏','–û–ø–∏—Å–∞–Ω–∏–µ/–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ','–ö–æ–ª-–≤–æ','–°—Ç–æ—Ä–æ–Ω–∞','–ü–æ–ª–æ–∂–µ–Ω–∏–µ','–ê—Ä—Ç–∏–∫—É–ª','–¶–µ–Ω–∞','–°—É–º–º–∞'];
    let csv = header.map(cell => `"${cell.replace(/"/g,'""')}"`).join(';') + '\n';
    lines.forEach(line => csv += line.map(cell => `"${(cell||'').toString().replace(/"/g,'""')}"`).join(';') + '\n');

    const bom = '\uFEFF';
    const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `zayavka_1c_${order}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
</script>

</body>
</html>
